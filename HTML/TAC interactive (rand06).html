<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1">
    <title>TAC — Keep Talking and Nobody Explodes Module</title>
    <link rel='stylesheet' type='text/css' href='css/font.css'>
    <link rel="stylesheet" type="text/css" href="css/normalize.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <script src="js/ktane-utils.js"></script>
    <script src="js/ruleseed.js"></script>
    <script>
        function setDefaultRules(rnd) { setRules(rnd); }
        function setRules(rnd)
        {
            document.getElementById('tac-names').innerHTML = rnd.shuffleFisherYates([ "Sam", "Tom", "Zoe", "Adam", "Alex", "Andy", "Anna", "Bill", "Carl", "Fred", "Kate", "Lucy", "Ryan", "Toby", "Will", "Zach", "Chris", "Craig", "David", "Emily", "Felix", "Harry", "James", "Jenny", "Julia", "Kevin", "Molly", "Peter", "Sally", "Sarah", "Steve", "Susan" ])
                .map((name, ix) => ({ name: name, ix: ix }))
                .sort((a, b) => a.name.localeCompare(b.name))
                .map(inf => `<tr><th>${inf.name}<${''}/th><td>${inf.ix}<${''}/td><${''}/tr>`)
                .join('');
        }
    </script>
    <style>
        #tac-names {
            float: right;
            margin-left: 1.5em;
        }
        #tac-names th, #tac-names td {
            padding: .2em .5em .1em .5em;
        }
        .cell{
            color: black;
            width: 2rem;
            height: 2rem;
            text-align: center;
            padding: 0.3rem;
        }

        .white{
            background: #fff;
        }

        .tint{
            background-color: rgb(192,192,255);
        }

        .exit{
            background-color: #808080;
        }

        input{
            width: 6rem;
        }
        input.input-right{
            text-align: right;
        }

        .pawn{font-size: 1.5rem;}
        .pawn.red{color: red}
        .pawn.green{color:green}
        .pawn.yellow{color:gold}
        .pawn.blue{color:blue}
        .cell.red:not(.pawn){background-color: red}
        .cell.green:not(.pawn){background-color: green}
        .cell.yellow:not(.pawn){background-color: gold}
        .cell.blue:not(.pawn){background-color: blue}
        .exit.selected{border: 0.2em solid #0080ff}
    </style>
    <script>
        function empty(x,y){
            if (x == 0 || y == 0 || x==12||y==4) return false;
            if ((x==2 || x==10)&&(y==1 || y==3)) return false;
            return true;
        }

        function getIndex(x,y){
            if (empty(x,y)) return -2;
            if (y==0) return x;
            if (x==12) return y+12;
            if (y==4) return 28-x;
            if (x==0) return 32-y;
            return -1;
        }

        var cells = [];
        var exits = [];
        var pawns = [-1,-1,-1,-1];
        var selected = -1;
        var colors = [-1,-1,-1,-1];

        function drawGrid(){
            let DOMgrid = document.getElementById('grid');
            let table = document.createElement('table');
            DOMgrid.appendChild(table);
            table.className = 'centered';
            for (let i = 0; i<5; i++){
                let row = document.createElement('tr');
                table.appendChild(row);
                for (let j = 0; j<13; j++){
                    let cell = document.createElement('td');
                    row.appendChild(cell);
                    cell.className = 'cell';
                    if ((j==3 || j==7) && (i==1 || i==3)){
                        cell.setAttribute("colspan","3");
                        cell.innerHTML = j==3? "<input>":"<input class='input-right'>";
                        j+=2;
                    }
                    if (empty(j,i)) cell.className = 'corner';
                    switch(getIndex(j,i)){
                        case -2: break;
                        case -1:
                            cell.classList.add('exit');
                            cell.setAttribute("onclick","pressExit("+exits.length+");");
                            exits.push(cell);
                            break;
                        default: {
                            if (getIndex(j,i)%2==0) cell.classList.add('white');
                            else cell.classList.add('tint');
                            cell.textContent = getIndex(j,i);
                            cells[getIndex(j,i)]=cell;
                            cell.setAttribute("onclick","pressCell("+getIndex(j,i)+");");
                            break;
                        }
                    }
                }
            }
        }

        function pressCell(index){
            if (selected == -1 || colors[selected] == -1) return;
            let flag = pawns[selected]!=index;
            if (pawns[selected]!=-1){
                cells[pawns[selected]].classList.remove('pawn');
                cells[pawns[selected]].classList.remove(['red', 'yellow', 'green', 'blue'][colors[selected]]);
                cells[pawns[selected]].textContent = pawns[selected];
                pawns[selected] = -1;
            }
            if (pawns.includes(index)){
                let oldIndex = pawns.indexOf(index)
                pawns[oldIndex] = -1;
                cells[index].classList.remove('pawn');
                cells[index].classList.remove(['red', 'yellow', 'green', 'blue'][colors[oldIndex]]);
                cells[index].textContent = index;
            }
            if (flag){
                pawns[selected] = index;
                cells[index].classList.add('pawn');
                cells[index].classList.add(['red', 'yellow', 'green', 'blue'][colors[selected]]);
                cells[index].textContent = 'i';
            }
        }

        function pressExit(index){
            if (selected==index) {
                exits[index].classList.remove(['red', 'yellow', 'green', 'blue'][colors[index]]);
                if (pawns[selected]!=-1) cells[pawns[selected]].classList.remove(['red', 'yellow', 'green', 'blue'][colors[index]]);
                colors[index] = (colors[index] + 1) % 4;
                if (pawns[selected]!=-1) cells[pawns[selected]].classList.add(['red', 'yellow', 'green', 'blue'][colors[index]]);
                exits[index].classList.add(['red', 'yellow', 'green', 'blue'][colors[index]]);
            }
            else {
                if (selected!=-1) exits[selected].classList.remove('selected');
                selected = index;
                exits[selected].classList.add('selected');
            }
        }

        function init(){
            drawGrid();
        }
    </script>
</head>
<body>
    <div class="section">
        <div class="page page-bg-02">
            <div class="page-header">
                <span class="page-header-doc-title">Keep Talking and Nobody Explodes Mod</span>
                <span class="page-header-section-title">TAC</span>
            </div>
            <div class="page-content">
                <img src="img/Component/TAC.svg" class="diagram">
                <h2>On the Subject of TAC</h2>
                <p class="flavour-text">Eminently TACable.</p>
                <p>The module displays a TAC board game with one colored pawn on it. However, there are three
                    additional invisible pawns in play, one of which is your partner and two are your opponents.</p>
                <p>To disarm TAC, you must play all five cards in your hand and get your pawn into its home with the last move.
                    The home is the darker square that is offset inside of the outer track.</p>
                <p>In some cases, this is not possible with the cards you are dealt at the start. In such a case, press the TAC button
                    in the center of the module to swap one of your cards for another. The module will strike if you do this
                    when your hand is winnable and if you attempt to play a card while your hand is unwinnable.</p>
                <h3>Determining the positions of the invisible pawns</h3>
                <p>Proceed clockwise from where you sit:</p>
                <ul>
                    <li>
                        From your pawn’s position, go forward a number of steps equal to the sum of the first and sixth
                        characters of the serial number (A=1, ..., Z=26) plus the offset associated with the next
                        player’s name. This is your first <em>opponent</em>.
                    </li>
                    <li>
                        From <em>that</em> pawn’s position, proceed equally with the second and fifth
                        characters of the serial number plus the offset associated with the next
                        player’s name. This is your <em>partner</em> (sitting opposite you).
                    </li>
                    <li>
                        Finally, proceed equally with the third and fourth serial number characters
                        and the final name to obtain the position of the other <em>opponent</em>.
                    </li>
                </ul>
                <h3>Rules of TAC</h3>
                <ul>
                    <li>Playing a regular numbered card moves the pawn clockwise around the board that number of spaces.
                        This move is only valid if there are no pieces in any of the intervening spaces.
                        Any piece on the final landing space is captured.</li>
                    <li>Playing a numbered card with a diamond symbol allows you the option to either play the card
                        just like a regular numbered card (use the button with the dots on it),
                        or to simply discard that card (use the button with the diamond shape on it).</li>
                    <li>Playing a reverse numbered card moves the pawn counter-clockwise.</li>
                </ul>
            </div>
            <div class="page-footer relative-footer">Page 1 of 3</div>
        </div>
        <div class="page page-bg-04">
            <div class="page-header">
                <span class="page-header-doc-title">Keep Talking and Nobody Explodes Mod</span>
                <span class="page-header-section-title">TAC</span>
            </div>
            <div class="page-content">
                <table id='tac-names'>
                </table>
                <ul>
                    <li>Playing a single-step numbered card moves the pawn clockwise that number of spaces and captures
                        all pieces along the way, including on the final landing space.</li>
                    <li>Playing a Warrior moves the pawn clockwise all the way to the next pawn on the board
                        and captures it.</li>
                    <li>A Trickster card allows you to swap the positions of any two pieces. After selecting
                        the Trickster card, tap an LED corresponding to a player, then another LED. Note
                        that you won’t see the pieces swap places unless one of them is your own.</li>
                </ul>
                <p>In cases where a numbered card allows the pawn to enter its home, an option appears letting
                    you choose to either enter your home (use the button with the house-shaped icon) or move
                    past it (use the double-arrow button). Reverse cards allow the pawn to move into its home
                    backwards.</p>
                <p>While playing, the TAC module will strike and restart in the following cases:</p>
                <ul>
                    <li>Your move would capture your partner.</li>
                    <li>You attempt to move across a piece in an intervening space.</li>
                    <li>You attempt to use the Trickster to swap a piece that has already been captured.</li>
                    <li>You move into your home when you still have additional cards in your hand.</li>
                    <li>You run out of cards and your pawn is not in its home.</li>
                </ul>
                <p>While the module is waiting for you to select an option button (e.g. discard) or an LED (Trickster),
                    the TAC button in the center can be pressed to cancel the current card.</p>
                <p>The TAC button can be held for a whole second to revert the module to its original state.</p>
            </div>
            <div class="page-footer relative-footer">Page 2 of 3</div>
        </div>
        <div class="page page-bg-01">
            <div class="page-header">
                <span class="page-header-doc-title">Keep Talking and Nobody Explodes Mod</span>
                <span class="page-header-section-title">TAC</span>
            </div>
            <div class="page-content">
                <div id="grid"></div>
            </div>
            <div class="page-footer relative-footer">Page 3 of 3</div>
        </div>
    </div>
    <script>
        init();
    </script>
</body>
</html>
